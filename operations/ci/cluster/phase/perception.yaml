- pwd
- 'export SRC_DIR=$PWD'
- sudo chown -R jenkins:jenkins /home/developer/ros_osrf/

###################################################################################################
# clone the workspace' submodules
- clone:
  - 'echo "Cloning perception_ws"'
  - git submodule update --recursive
  - rosdep update

###################################################################################################
# build the workspace
- build:
  - 'echo "Building perception_ws"'

  # build the workspace deps
  - deps:
    # - source /home/developer/ros_osrf/install/setup.bash
    # - rosdep install --from-paths . --ignore-src --rosdistro melodic -y
    - cd $SRC_DIR/perception/deps/catkin/
    - catkin config --extend /home/developer/ros_osrf/install
    - catkin build --no-status

  # build the workspace
  - ws:
    # - ls ../../../
    - cd $SRC_DIR/perception/
    - catkin config -a --cmake-args -DCMAKE_BUILD_TYPE=Release -DOVERRIDE_DEFAULT_NVCC_FLAGS=ON -DCUDA_NVCC_FLAGS="-O3;-gencode arch=compute_50,code=sm_50";
    - catkin build --no-status

###################################################################################################
# unit tests
- test:
  - export LD_LIBRARY_PATH="/usr/local/cuda/extras/CUPTI/lib64:/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/usr/local/cuda-10.0/compat:/usr/local/cuda-10.0/lib64"
  - cd $SRC_DIR/perception/object_detection/inference/scripts
  - python test_multi_object_detector.py 

###################################################################################################
# clean the workspace
- clean:
  - ws:
    - cd $SRC_DIR/perception/
    - catkin clean -y
  # clean workspace deps
  - deps:
    - cd $SRC_DIR/perception/deps/catkin/
    - catkin clean -y
